name: E2E Sync with UI Changes

on:
  pull_request:
    paths:
      - 'frontend/src/components/**'
      - 'frontend/src/app/**'

jobs:
  sync-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write  # Required for Claude Code Action OIDC token

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get changed files
        id: changes
        # Pinned to v46.0.1 due to CVE-2025-30066 (supply-chain compromise in v44-v45.0.7)
        uses: tj-actions/changed-files@v46.0.1
        with:
          files: |
            frontend/src/components/**
            frontend/src/app/**

      - name: Check if E2E update needed
        if: steps.changes.outputs.any_changed == 'true'
        run: |
          echo "Changed UI files detected:"
          echo "${{ steps.changes.outputs.all_changed_files }}"

      - name: Setup Node.js
        if: steps.changes.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        if: steps.changes.outputs.any_changed == 'true'
        run: npm ci
        working-directory: ./frontend

      # E2E debugging instructions are centralized in .claude/skills/e2e-debug/SKILL.md
      # to ensure consistency across all E2E workflows
      #
      # Security: Claude Code only has file read/edit permissions.
      # Git operations are handled by the workflow with fixed commit messages
      # to prevent prompt injection attacks.
      - name: Update E2E tests with Claude
        if: steps.changes.outputs.any_changed == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ä»¥ä¸‹ã®UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:
            ${{ steps.changes.outputs.all_changed_files }}

            ã“ã‚Œã‚‰ã®å¤‰æ›´ã«é–¢é€£ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆã®æ›´æ–°ãŒå¿…è¦ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            ## æ‰‹é †
            1. ã¾ãš .claude/skills/e2e-debug/SKILL.md ã‚’èª­ã‚“ã§ã€E2Eãƒ‡ãƒãƒƒã‚°ã®æ‰‹é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            2. å¤‰æ›´ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’èª­ã¿å–ã‚‹
            3. frontend/e2e/pages/ ã®é–¢é€£ã™ã‚‹Page Objectã‚’ç‰¹å®š
            4. ä»¥ä¸‹ã®å¤‰æ›´ãŒãªã„ã‹ç¢ºèª:
               - aria-label, roleå±æ€§ã®å¤‰æ›´
               - ãƒœã‚¿ãƒ³/ãƒªãƒ³ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´
               - ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®æ§‹é€ å¤‰æ›´
            5. å¿…è¦ã«å¿œã˜ã¦Page Objectã®ãƒ­ã‚±ãƒ¼ã‚¿ã‚’æ›´æ–°
            6. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«å½±éŸ¿ãŒãªã„ã‹ç¢ºèª

            ## é‡è¦
            ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£ã®ã¿è¡Œã£ã¦ãã ã•ã„ã€‚gitæ“ä½œã¯ä¸è¦ã§ã™ï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•ã§è¡Œã„ã¾ã™ï¼‰ã€‚
          claude_args: --allowedTools "Read,Edit,Write,Glob,Grep"

      # Security: Use PR instead of direct push to respect branch protection rules.
      # Commit message is fixed to prevent prompt injection.
      - name: Create sync PR
        if: steps.changes.outputs.any_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(e2e): sync with UI component changes"
          title: "fix(e2e): UIå¤‰æ›´ã«è¿½å¾“ by Claude Code"
          body: |
            ## ğŸ¤– E2EåŒæœŸ PR

            UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€Claude CodeãŒE2Eãƒ†ã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚

            ### å¤‰æ›´ã•ã‚ŒãŸUIãƒ•ã‚¡ã‚¤ãƒ«
            ```
            ${{ steps.changes.outputs.all_changed_files }}
            ```

            ### ç¢ºèªäº‹é …
            - [ ] ãƒ­ã‚±ãƒ¼ã‚¿ã®æ›´æ–°ãŒé©åˆ‡ã‹ç¢ºèª
            - [ ] ãƒ†ã‚¹ãƒˆãŒæ„å›³ã—ãŸå‹•ä½œã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã‹ç¢ºèª

            ---
            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          branch: fix/e2e-sync-${{ github.run_id }}
          base: ${{ github.head_ref }}
          labels: |
            auto-fix
            e2e
