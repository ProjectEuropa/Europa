name: E2E Auto Fix

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]

jobs:
  auto-fix:
    # Only run when Frontend CI failed and it's not an auto-fix branch (prevent infinite loops)
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.head_branch, 'fix/e2e-auto-')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Download Playwright report
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: playwright-report
          path: playwright-report
        continue-on-error: true

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: playwright-test-results
          path: test-results
        continue-on-error: true

      - name: Check if E2E artifacts exist
        id: check-artifacts
        run: |
          # E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œ
          # playwright-reportã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€ã‹ã¤test-resultsã«å¤±æ•—æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç­‰ãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -d "playwright-report" ] && [ -n "$(ls -A playwright-report 2>/dev/null)" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "E2E test artifacts found - proceeding with auto-fix"
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo "No E2E test artifacts found - this failure is not E2E related, skipping auto-fix"
          fi

      - name: Setup Node.js
        if: steps.check-artifacts.outputs.has_artifacts == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        if: steps.check-artifacts.outputs.has_artifacts == 'true'
        run: npm ci
        working-directory: ./frontend

      - name: Run Claude Code to fix E2E
        if: steps.check-artifacts.outputs.has_artifacts == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚è‡ªå‹•ä¿®å¾©ã‚’è©¦ã¿ã¦ãã ã•ã„ã€‚

            ## å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆã®å ´æ‰€
            - playwright-report/ - Playwrightã®ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ
            - test-results/ - å¤±æ•—æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ/å‹•ç”»

            ## æ‰‹é †
            1. playwright-report/index.html ã‚’èª­ã‚“ã§å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’ç‰¹å®š
            2. å¤±æ•—åŸå› ã‚’åˆ†æï¼ˆãƒ­ã‚±ãƒ¼ã‚¿å¤‰æ›´ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€APIå¤‰æ›´ãªã©ï¼‰
            3. frontend/e2e/ ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ Page Object ã‚’ä¿®æ­£
            4. ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ­ã‚±ãƒ¼ã‚¿å„ªå…ˆé †ä½ã‚’å®ˆã‚‹:
               getByRole > getByLabel > getByText > getByTestId

            ## ä¿®æ­£å¾Œ
            ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ git add ã¨ git commit ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "fix(e2e): è‡ªå‹•ä¿®å¾© - [ä¿®æ­£å†…å®¹ã®è¦ç´„]"
          claude_args: --allowed-tools "Read,Edit,Write,Bash(git add:*),Bash(git commit:*),Bash(npm run test:e2e:*),Glob,Grep"

      - name: Create fix PR
        if: steps.check-artifacts.outputs.has_artifacts == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "fix(e2e): è‡ªå‹•ä¿®å¾© by Claude Code"
          body: |
            ## ğŸ¤– è‡ªå‹•ä¿®å¾© PR

            E2Eãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’æ¤œçŸ¥ã—ã€Claude CodeãŒè‡ªå‹•ä¿®å¾©ã‚’è©¦ã¿ã¾ã—ãŸã€‚

            ### å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
            - Run: ${{ github.event.workflow_run.html_url }}
            - Branch: `${{ github.event.workflow_run.head_branch }}`

            ### ç¢ºèªäº‹é …
            - [ ] ä¿®æ­£å†…å®¹ãŒé©åˆ‡ã‹ç¢ºèª
            - [ ] ãƒ†ã‚¹ãƒˆãŒæ„å›³ã—ãŸå‹•ä½œã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã‹ç¢ºèª
            - [ ] é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ãŒãªã„ã‹ç¢ºèª

            ---
            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          branch: fix/e2e-auto-${{ github.run_id }}
          base: ${{ github.event.workflow_run.head_branch }}
          labels: |
            auto-fix
            e2e
          delete-branch: true
